# Multi-Region Render Deployment Configuration
# This file shows how to deploy PhotoStream to multiple regions for better scalability
#
# To use this configuration:
# 1. Rename this file to render.yaml (backup the original first)
# 2. Update the environment variables with your actual values
# 3. Push to GitHub - Render will automatically deploy all 3 regional services
# 4. Note the URLs for each service and update the discovery.py REGIONAL_SERVERS mapping

services:
  # ========================================
  # US WEST REGION (Primary/Discovery)
  # ========================================
  - type: web
    name: photostream-api-us-west
    env: python
    region: oregon  # US West region
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT
    envVars:
      # Region identifier
      - key: REGION_NAME
        value: us-west

      # Database
      - key: MONGODB_URL
        sync: false
      - key: DATABASE_NAME
        value: photostream

      # Security
      - key: SECRET_KEY
        generateValue: true

      # Cloudinary (shared across regions)
      - key: CLOUDINARY_CLOUD_NAME
        sync: false
      - key: CLOUDINARY_API_KEY
        sync: false
      - key: CLOUDINARY_API_SECRET
        sync: false

      # Redis (shared across regions)
      - key: REDIS_URL
        fromService:
          type: redis
          name: photostream-redis
          property: connectionString

      - key: CACHE_TTL
        value: 300

      - key: PYTHON_VERSION
        value: 3.11.0

      # Regional server URLs (update these after first deployment)
      - key: SERVER_US_WEST
        value: https://photostream-api-us-west.onrender.com
      - key: SERVER_US_EAST
        value: https://photostream-api-us-east.onrender.com
      - key: SERVER_EU
        value: https://photostream-api-eu.onrender.com

  # ========================================
  # US EAST REGION
  # ========================================
  - type: web
    name: photostream-api-us-east
    env: python
    region: virginia  # US East region
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT
    envVars:
      # Region identifier
      - key: REGION_NAME
        value: us-east

      # Database (same as US West - shared MongoDB)
      - key: MONGODB_URL
        sync: false
      - key: DATABASE_NAME
        value: photostream

      # Security (should match across regions for session compatibility)
      - key: SECRET_KEY
        sync: false  # Use same secret across regions

      # Cloudinary (shared)
      - key: CLOUDINARY_CLOUD_NAME
        sync: false
      - key: CLOUDINARY_API_KEY
        sync: false
      - key: CLOUDINARY_API_SECRET
        sync: false

      # Redis (shared)
      - key: REDIS_URL
        fromService:
          type: redis
          name: photostream-redis
          property: connectionString

      - key: CACHE_TTL
        value: 300

      - key: PYTHON_VERSION
        value: 3.11.0

      # Regional server URLs
      - key: SERVER_US_WEST
        value: https://photostream-api-us-west.onrender.com
      - key: SERVER_US_EAST
        value: https://photostream-api-us-east.onrender.com
      - key: SERVER_EU
        value: https://photostream-api-eu.onrender.com

  # ========================================
  # EUROPE REGION
  # ========================================
  - type: web
    name: photostream-api-eu
    env: python
    region: frankfurt  # Europe region
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT
    envVars:
      # Region identifier
      - key: REGION_NAME
        value: eu-central

      # Database (same as others - shared MongoDB)
      - key: MONGODB_URL
        sync: false
      - key: DATABASE_NAME
        value: photostream

      # Security (should match across regions)
      - key: SECRET_KEY
        sync: false  # Use same secret across regions

      # Cloudinary (shared)
      - key: CLOUDINARY_CLOUD_NAME
        sync: false
      - key: CLOUDINARY_API_KEY
        sync: false
      - key: CLOUDINARY_API_SECRET
        sync: false

      # Redis (shared)
      - key: REDIS_URL
        fromService:
          type: redis
          name: photostream-redis
          property: connectionString

      - key: CACHE_TTL
        value: 300

      - key: PYTHON_VERSION
        value: 3.11.0

      # Regional server URLs
      - key: SERVER_US_WEST
        value: https://photostream-api-us-west.onrender.com
      - key: SERVER_US_EAST
        value: https://photostream-api-us-east.onrender.com
      - key: SERVER_EU
        value: https://photostream-api-eu.onrender.com

  # ========================================
  # SHARED REDIS (Single instance, all regions connect to it)
  # ========================================
  # Note: For better performance, you could create regional Redis instances
  # and configure each regional API to use its local Redis
  - type: redis
    name: photostream-redis
    region: oregon  # Choose closest to primary traffic
    plan: free
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []

# ========================================
# DEPLOYMENT NOTES
# ========================================
#
# 1. Database Strategy:
#    - Use MongoDB Atlas with multi-region clusters for best performance
#    - Or use a single region MongoDB (simple but may have higher latency)
#
# 2. Redis Strategy:
#    - Shared Redis (shown above): Simple, but may have latency
#    - Regional Redis: Better performance, more complex cache invalidation
#
# 3. Session/Auth Considerations:
#    - Use same SECRET_KEY across all regions for JWT compatibility
#    - Or store sessions in shared Redis
#
# 4. File Uploads (Cloudinary):
#    - Already centralized, works across regions
#
# 5. Free Tier Limitations:
#    - Services spin down after 15 minutes of inactivity
#    - Consider using a keep-alive service (see docs)
#    - Or upgrade to Starter ($7/mo per service)
#
# 6. Testing:
#    - Test each region individually first
#    - Then test the discovery endpoint
#    - Use VPN to test geo-routing from different locations
#
# 7. Monitoring:
#    - Use /api/regions endpoint to check health of all regions
#    - Set up alerts if any region goes offline
#
# 8. Cost Estimate:
#    - Free tier: $0 (3 web services + 1 Redis, all free)
#    - Starter tier: ~$28/mo (3 web @ $7 each + 1 Redis @ $7)
